From f411876086099638677d35c4cc023e5d046eff6a Mon Sep 17 00:00:00 2001
From: Vlad Zahorodnii <vladzzag@gmail.com>
Date: Fri, 17 Jan 2020 21:16:41 +0200
Subject: [PATCH] Fix build with KDE Plasma 5.18 LTS

Fixes #21
---
 src/YetAnotherMagicLampEffect.cc | 10 ++++++++--
 src/YetAnotherMagicLampEffect.h  |  5 +++++
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/src/YetAnotherMagicLampEffect.cc b/src/YetAnotherMagicLampEffect.cc
index 98dbe59..77e35c1 100644
--- a/src/YetAnotherMagicLampEffect.cc
+++ b/src/YetAnotherMagicLampEffect.cc
@@ -168,7 +168,11 @@ void YetAnotherMagicLampEffect::prePaintWindow(KWin::EffectWindow* w, KWin::Wind
     KWin::effects->prePaintWindow(w, data, time);
 }
 
+#if KWIN_EFFECT_API_VERSION <= KWIN_EFFECT_API_MAKE_VERSION(0, 228)
 void YetAnotherMagicLampEffect::drawWindow(KWin::EffectWindow* w, int mask, QRegion region, KWin::WindowPaintData& data)
+#else
+void YetAnotherMagicLampEffect::drawWindow(KWin::EffectWindow* w, int mask, const QRegion& region, KWin::WindowPaintData& data)
+#endif
 {
     auto modelIt = m_models.constFind(w);
     if (modelIt == m_models.constEnd()) {
@@ -180,11 +184,13 @@ void YetAnotherMagicLampEffect::drawWindow(KWin::EffectWindow* w, int mask, QReg
     QVector<WindowQuad> quads = m_meshRenderer->makeGrid(w, m_gridResolution);
     (*modelIt).apply(quads);
 
+    QRegion clipRegion = region;
+
     if ((*modelIt).needsClip()) {
-        region = (*modelIt).clipRegion();
+        clipRegion = (*modelIt).clipRegion();
     }
 
-    m_meshRenderer->render(w, quads, texture, region);
+    m_meshRenderer->render(w, quads, texture, clipRegion);
 }
 
 bool YetAnotherMagicLampEffect::isActive() const
diff --git a/src/YetAnotherMagicLampEffect.h b/src/YetAnotherMagicLampEffect.h
index 8d4325a..0455278 100644
--- a/src/YetAnotherMagicLampEffect.h
+++ b/src/YetAnotherMagicLampEffect.h
@@ -40,7 +40,12 @@ class YetAnotherMagicLampEffect : public KWin::Effect {
     void postPaintScreen() override;
 
     void prePaintWindow(KWin::EffectWindow* w, KWin::WindowPrePaintData& data, int time) override;
+
+#if KWIN_EFFECT_API_VERSION <= KWIN_EFFECT_API_MAKE_VERSION(0, 228)
     void drawWindow(KWin::EffectWindow* w, int mask, QRegion region, KWin::WindowPaintData& data) override;
+#else
+    void drawWindow(KWin::EffectWindow* w, int mask, const QRegion& region, KWin::WindowPaintData& data) override;
+#endif
 
     bool isActive() const override;
     int requestedEffectChainPosition() const override;
