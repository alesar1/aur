--- src/http.c	2018-03-30 20:06:27.834717998 +0700
+++ src/http.c.new	2018-03-30 20:07:07.524800224 +0700
@@ -155,8 +155,8 @@
 			}
 
 			if (header_size) {
-				/* We saw the whole header, let's check if the
-				 * body is done as well */
+				/* We saw the whole header, */
+				/* let's check if the body is done as well */
 				if (chunked) {
 					/* Last chunk terminator. Done naively. */
 					if (bytes_read >= 7 &&
@@ -481,7 +481,7 @@
 	char reqid[32] = { '\0' };
 	char polid[32] = { '\0' };
 	char group[128] = { '\0' };
-	char data[256], token[128], tokenresponse[256];
+	char data[256], token[128];
 	char *res = NULL;
 
 	url_encode(username, tunnel->config->username);
@@ -511,6 +511,8 @@
 	}
 	ret = get_auth_cookie(tunnel, res);
 	if (ret == ERR_HTTP_NO_COOKIE) {
+		struct vpn_config *cfg = tunnel->config;
+
 		/* If the response body includes a tokeninfo= parameter,
 		 * it means the VPN gateway expects two-factor authentication.
 		 * It sends a one-time authentication credential for example
@@ -534,11 +536,18 @@
 		get_value_from_response(res, "reqid=", reqid, 32);
 		get_value_from_response(res, "polid=", polid, 32);
 
-		read_password("Two-factor authentication token: ", tokenresponse, 255);
+		if (cfg->otp[0] == '\0') {
+			read_password("Two-factor authentication token: ",
+			              cfg->otp, FIELD_SIZE);
+			if (cfg->otp[0] == '\0') {
+				log_error("No token specified\n");
+				return 0;
+			}
+		}
 
 		snprintf(data, 256, "username=%s&realm=%s&reqid=%s&polid=%s&grp=%s"
 		         "&code=%s&code2=&redir=%%2Fremote%%2Findex&just_logged_in=1",
-		         username, realm, reqid, polid, group, tokenresponse);
+		         username, realm, reqid, polid, group, cfg->otp);
 
 		ret = http_request(tunnel, "POST", "/remote/logincheck", data, &res);
 		if (ret != 1)
