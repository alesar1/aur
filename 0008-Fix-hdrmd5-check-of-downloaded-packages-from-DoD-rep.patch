From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Daniel Mach <daniel.mach@suse.com>
Date: Tue, 29 Mar 2022 09:59:08 +0200
Subject: [PATCH] Fix hdrmd5 check of downloaded packages from DoD repos
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

(cherry picked from commit 8384a1fdff980590244c211024127542d08a9716)

Re:
openSUSE/osc#1016

Signed-off-by: Bj√∂rn Bidar <bjorn.bidar@jolla.com>
---
 osc/fetch.py | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/osc/fetch.py b/osc/fetch.py
index 8a1c4e3466d26ce5f503dfd93c4049b1693d9d5b..9b34b002e531c01e478a571b7b349dd9657a01a6 100644
--- a/osc/fetch.py
+++ b/osc/fetch.py
@@ -256,7 +256,9 @@ class Fetcher:
                         # if the checksum of the downloaded package doesn't match,
                         # delete it and mark it for downloading from the API
                         hdrmd5 = packagequery.PackageQuery.queryhdrmd5(i.fullfilename)
-                        if not hdrmd5 or hdrmd5 != i.hdrmd5:
+                        # packages with hdrmd5 == 'd0d...' come from 'download on demand' repos
+                        # and their checksum is not known to the server yet, so we skip their checksum check
+                        if not hdrmd5 or (hdrmd5 != i.hdrmd5 and i.hdrmd5 != 'd0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0'):
                             print('%s/%s: attempting download from api, since the hdrmd5 did not match - %s != %s'
                                 % (i.project, i.name, hdrmd5, i.hdrmd5))
                             os.unlink(i.fullfilename)
