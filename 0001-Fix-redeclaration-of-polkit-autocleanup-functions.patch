From bc339aa6576ef5c3a50f818acdc3c8dc611c3a72 Mon Sep 17 00:00:00 2001
From: Philip Withnall <philip.withnall@collabora.co.uk>
Date: Tue, 22 Nov 2016 16:13:22 +0000
Subject: [PATCH 001/146] Fix redeclaration of polkit autocleanup functions
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

ifdef cannot be used to determine if a C symbol is defined, as itâ€™s
evaluated by the preprocessor, before symbols are parsed. Instead, try
to detect whether polkit.h is suitably recent enough to define its own
auto-cleanup functions.

Signed-off-by: Richard Hughes <richard@hughsie.com>
---
 configure.ac  | 8 ++++++++
 src/fu-main.c | 2 +-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index dc9bfeb..95e93fe 100644
--- a/configure.ac
+++ b/configure.ac
@@ -155,6 +155,14 @@ if test -z $GCAB ; then
 	AC_MSG_ERROR([gcab program not found])
 fi
 
+# 0.114 introduced autocleanup functions for its types.
+PKG_CHECK_MODULES([POLKIT_0_114], [polkit-gobject-1 >= 0.114],
+                  [have_polkit_0_114=yes], [have_polkit_0_114=no])
+AS_IF([test "$have_polkit_0_114" = "yes"], [
+	AC_DEFINE([HAVE_POLKIT_0_114],[1],
+	          [Define as 1 if you have polkit >= 0.114])
+])
+
 # ColorHug support
 AC_ARG_ENABLE(colorhug,
 	      AS_HELP_STRING([--enable-colorhug],
diff --git a/src/fu-main.c b/src/fu-main.c
index 4f22e11..c5b6f39 100644
--- a/src/fu-main.c
+++ b/src/fu-main.c
@@ -59,7 +59,7 @@
   #include "fu-provider-dell.h"
 #endif
 
-#ifndef PolkitAuthorizationResult_autoptr
+#ifndef HAVE_POLKIT_0_114
 G_DEFINE_AUTOPTR_CLEANUP_FUNC(PolkitAuthorizationResult, g_object_unref)
 G_DEFINE_AUTOPTR_CLEANUP_FUNC(PolkitSubject, g_object_unref)
 #endif
-- 
2.11.1

