From a8184dc767520b4f4904fc5787b14ff9ffe4c1b4 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Sun, 26 Jul 2020 12:33:33 +0200
Subject: [PATCH] mkinitcpio: Add support for the zstd compressor

---
 PKGBUILD                  | 1 +
 lsinitcpio                | 6 ++++++
 man/mkinitcpio.conf.5.txt | 2 +-
 mkinitcpio                | 3 +++
 mkinitcpio.conf           | 1 +
 5 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/PKGBUILD b/PKGBUILD
index 3536a48..c7e1ed5 100644
--- a/PKGBUILD
+++ b/PKGBUILD
@@ -15,6 +15,7 @@ optdepends=('xz: Use lzma or xz compression for the initramfs image'
             'bzip2: Use bzip2 compression for the initramfs image'
             'lzop: Use lzo compression for the initramfs image'
             'lz4: Use lz4 compression for the initramfs image'
+            'zstd: Use zstd compression for the initramfs image'
             'mkinitcpio-nfs-utils: Support for root filesystem on NFS')
 backup=(etc/mkinitcpio.conf)
 
diff --git a/lsinitcpio b/lsinitcpio
index bcb4a19..c170985 100755
--- a/lsinitcpio
+++ b/lsinitcpio
@@ -131,6 +131,12 @@ detect_filetype() {
         return
     fi
 
+    read -rd '' bytes < <(hexdump -n 4 -e '"%x"' "$1")
+    if [[ $bytes == 'fd2fb528' ]]; then
+        echo 'zstd'
+        return
+    fi
+
     # still nothing? hrmm, maybe the user goofed and it's a kernel
     if kver "$1" >/dev/null; then
         die '%s is a kernel image, not an initramfs image!' "$1"
diff --git a/man/mkinitcpio.conf.5.txt b/man/mkinitcpio.conf.5.txt
index 9c8d000..83037ca 100644
--- a/man/mkinitcpio.conf.5.txt
+++ b/man/mkinitcpio.conf.5.txt
@@ -54,7 +54,7 @@ Variables
 
 	Defines a program to filter the generated image through. As of linux 2.6.38,
 	the kernel understands the compression formats yielded by the *gzip*, *bzip2*,
-	*lz4*, *lzop*, *lzma*, and *xz* compressors. If unspecified, this setting
+	*lz4*, *lzop*, *lzma*, *xz* and *zstd* compressors. If unspecified, this setting
 	defaults to *gzip* compression. In order to create an uncompressed image, define
 	this variable as *cat*.
 +
diff --git a/mkinitcpio b/mkinitcpio
index ba27433..e6390d6 100755
--- a/mkinitcpio
+++ b/mkinitcpio
@@ -211,6 +211,9 @@ build_image() {
         lz4)
             COMPRESSION_OPTIONS+=('-l')
             ;;
+        zstd)
+            COMPRESSION_OPTIONS+=('-22' '--ultra')
+            ;;
     esac
 
     pushd "$BUILDROOT" >/dev/null
diff --git a/mkinitcpio.conf b/mkinitcpio.conf
index b926b90..ba1cce3 100644
--- a/mkinitcpio.conf
+++ b/mkinitcpio.conf
@@ -60,6 +60,7 @@ HOOKS=(base udev autodetect modconf block filesystems keyboard fsck)
 #COMPRESSION="xz"
 #COMPRESSION="lzop"
 #COMPRESSION="lz4"
+#COMPRESSION="zstd"
 
 # COMPRESSION_OPTIONS
 # Additional options for the compressor
-- 
2.28.0

