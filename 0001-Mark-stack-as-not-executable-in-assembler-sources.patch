From e3c21e9833c878e7edb60212dbf1f2fd03393fa5 Mon Sep 17 00:00:00 2001
From: Jan Cholasta <grubber@grubber.cz>
Date: Thu, 18 Feb 2016 10:56:03 +0100
Subject: [PATCH] Mark stack as not executable in assembler sources

---
 src/asm_ia32/a.asm     | 10 ++++++++++
 src/asm_ia32/misc.asm  | 10 ++++++++++
 src/asm_ia32/tmap.asm  | 10 ++++++++++
 src/asm_ia32/tmap2.asm | 10 ++++++++++
 src/asm_ia32/tmap3.asm | 10 ++++++++++
 src/asm_x86_64/tmap3.s |  1 +
 6 files changed, 51 insertions(+)

diff --git a/src/asm_ia32/a.asm b/src/asm_ia32/a.asm
index b4bc529..bbde26b 100644
--- a/src/asm_ia32/a.asm
+++ b/src/asm_ia32/a.asm
@@ -810,3 +810,13 @@ align 16
 GLOBAL _rtext_a_end
 _rtext_a_end:
 %endif
+
+%ifidn __OUTPUT_FORMAT__,elf
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf32
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf64
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
diff --git a/src/asm_ia32/misc.asm b/src/asm_ia32/misc.asm
index 69e7238..ddd94ec 100644
--- a/src/asm_ia32/misc.asm
+++ b/src/asm_ia32/misc.asm
@@ -198,3 +198,13 @@ BestColor_MMX:
 		pop		ebx
 		emms
 		ret
+
+%ifidn __OUTPUT_FORMAT__,elf
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf32
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf64
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
diff --git a/src/asm_ia32/tmap.asm b/src/asm_ia32/tmap.asm
index 00e6333..539d74d 100644
--- a/src/asm_ia32/tmap.asm
+++ b/src/asm_ia32/tmap.asm
@@ -1891,3 +1891,13 @@ _ASM_PatchPitch:
 		selfmod rtext_start, rtext_end
 		call	setpitch3
 		jmp		setvlinebpl_
+
+%ifidn __OUTPUT_FORMAT__,elf
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf32
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf64
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
diff --git a/src/asm_ia32/tmap2.asm b/src/asm_ia32/tmap2.asm
index e1f1668..39603fb 100644
--- a/src/asm_ia32/tmap2.asm
+++ b/src/asm_ia32/tmap2.asm
@@ -638,3 +638,13 @@ rtext_end:
 GLOBAL _rtext_tmap2_end
 _rtext_tmap2_end:
 %endif
+
+%ifidn __OUTPUT_FORMAT__,elf
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf32
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf64
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
diff --git a/src/asm_ia32/tmap3.asm b/src/asm_ia32/tmap3.asm
index 3161ff3..39233eb 100644
--- a/src/asm_ia32/tmap3.asm
+++ b/src/asm_ia32/tmap3.asm
@@ -342,3 +342,13 @@ shift12:	shr	ecx,16
 GLOBAL _rtext_tmap3_end
 _rtext_tmap3_end:
 %endif
+
+%ifidn __OUTPUT_FORMAT__,elf
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf32
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
+%ifidn __OUTPUT_FORMAT__,elf64
+section .note.GNU-stack noalloc noexec nowrite progbits
+%endif
diff --git a/src/asm_x86_64/tmap3.s b/src/asm_x86_64/tmap3.s
index 867d11c..e27f05f 100644
--- a/src/asm_x86_64/tmap3.s
+++ b/src/asm_x86_64/tmap3.s
@@ -139,3 +139,4 @@ vltepilog:
 		.align 16
 
 
+		.section	.note.GNU-stack,"",@progbits
-- 
2.7.1

