1,2c1,14
< GITREV=`git describe | cut -c 2-`
< LDFLAGS=-ldflags="-X 'github.com/writeas/writefreely.softwareVer=$(GITREV)'"
---
> # make(1) from NetBSD (bmake on many Linux's) uses $(.CURDIR), but GNU Make uses
> # $(CURDIR). Normalize on $(.CURDIR) by setting it to $(CURDIR) if not set, and
> # then $(PWD) if still not set.
> .CURDIR ?= $(CURDIR)
> .CURDIR ?= $(PWD)
> 
> # For reproducible builds, don't store the current build directory by default;
> # instead store only the path from the root of the repo (so there is still
> # enough info in debug messages to find the correct file).
> GCFLAGS  = -gcflags="all=-trimpath=$(.CURDIR)"
> ASMFLAGS = -asmflags="all=-trimpath=$(.CURDIR)"
> 
> GITREV!=git describe --tags | cut -c 2-
> GOLDFLAGS=-ldflags="-X 'github.com/writeas/writefreely.softwareVer=$(GITREV)' -extldflags '$(LDFLAGS)'"
5,7c17,19
< GOINSTALL=$(GOCMD) install $(LDFLAGS)
< GOBUILD=$(GOCMD) build $(LDFLAGS)
< GOTEST=$(GOCMD) test $(LDFLAGS)
---
> GOINSTALL=$(GOCMD) install $(GOLDFLAGS) $(GCFLAGS) $(ASMFLAGS)
> GOBUILD=$(GOCMD) build $(GOLDFLAGS) $(GCFLAGS) $(ASMFLAGS)
> GOTEST=$(GOCMD) test $(GOLDFLAGS) $(GCFLAGS) $(ASMFLAGS)
29c41
< 	xgo --targets=linux/amd64, -dest build/ $(LDFLAGS) -tags='sqlite' -out writefreely ./cmd/writefreely
---
> 	xgo --targets=linux/amd64, -dest build/ $(GOLDFLAGS) -tags='sqlite' -out writefreely ./cmd/writefreely
35c47
< 	xgo --targets=windows/amd64, -dest build/ $(LDFLAGS) -tags='sqlite' -out writefreely ./cmd/writefreely
---
> 	xgo --targets=windows/amd64, -dest build/ $(GOLDFLAGS) -tags='sqlite' -out writefreely ./cmd/writefreely
41c53
< 	xgo --targets=darwin/amd64, -dest build/ $(LDFLAGS) -tags='sqlite' -out writefreely ./cmd/writefreely
---
> 	xgo --targets=darwin/amd64, -dest build/ $(GOLDFLAGS) -tags='sqlite' -out writefreely ./cmd/writefreely
