#!/bin/bash
#
# Remove packages from the rebuild-pending list.

readonly REBUILD_DETECTOR_CACHE_DIR="/var/cache/rebuild-detector"

get_pkg_info() {
    pacman -Sl | awk '{ print $1,$2 }'
}


tmp=$(mktemp -dt "rebuild-detector-cleanup-hook.XXXXXXXX") || exit
trap 'rm -rf $tmp' EXIT
cd "$tmp" || exit

get_pkg_info >pkg_info

while read -r pkg; do
    repo=$(grep " $pkg" pkg_info | cut -d' ' -f1)
    file="$REBUILD_DETECTOR_CACHE_DIR/$repo.list"
    [ -f "$file" ] && sed -i "/^$pkg$/d" "$file"
done

exit 0
