#!/bin/sh

set -e

bootstrap_install() {
    install -dv "$destdir"
    install -dv "$bindir"
    install -dv "$libdir"
    install -d "$prefix/bin/"
    install -d "$prefix/share/applications/"
    install -pm 0644 "./evesetup.shlib" "$libdir"
    install -pm 0644 "./evelauncher-${elver}.tar.gz" "$libdir"
    sed -i s,SETUPDIR=\"\",SETUPDIR=\"$destdir\", ./evelauncher.sh
    for cmd in evelauncher.sh evewine evewinetricks everegedit evewinecfg evebackup ;do
	if [ -f "./$cmd" ] ;then
	    sed -i s,./evesetup.shlib,$libdir/evesetup.shlib, ./$cmd
	    install -p "./$cmd" "$bindir/"
	else
	    ln -sf evewine "$bindir/$cmd"
	fi
	[ "$bindir" != "$prefix/bin" ] && ln -s "$bindir/$cmd" "$prefix/bin/$cmd"
	if [ ! "$cmd" = "evewine" ] ;then
	    oexec=$(grep Exec= ./${cmd%.*}.desktop)
	    sed -i s,$oexec,Exec=$prefix/bin/$cmd, ./${cmd%.*}.desktop
	    install -m 0644 "./${cmd%.*}.desktop" "$prefix/share/applications/"
	fi
    done
    for icons in $(find . -type f -name '*.png') ;do
	install -D -m 0644 "$icons" "$prefix/share/${icons#*/}"
    done
    if [ -x $(which gtk-update-icon-cache) ] ;then
	if [ -f "${prefix}/share/icons/hicolor/icon-theme.cache" ] ;then
	    gtk-update-icon-cache -t -f "${prefix}/share/icons/hicolor" 2>/dev/null
	    chmod 0644 "${prefix}/share/icons/hicolor/icon-theme.cache"
	fi
    fi
}

bootstrap_remove() {
    for icons in $(find . -type f -name '*.png') ;do
	rm -f "$prefix/share/${icons#*/}"
    done
    for cmd in evelauncher.sh everegedit evewine evewinecfg evewinetricks evebackup ;do
	rm -fv "$prefix/bin/$cmd"
	if [ ! "$cmd" = "evewine" ] ;then
	    rm -f "$prefix/share/applications/${cmd%.*}.desktop"
	fi
    done
    rm -rfv "$destdir"
}

check_req() {
    if [ ! -x "$(which wine 2>/dev/null)" ] ;then
	req="${req}wine\n"
    fi
    if [ ! -x "$(which winetricks 2>/dev/null)" ] ;then
	req="${req}winetricks\n"
    fi
    tar xf evelauncher-$elver.tar.gz
    cd evelauncher/
    req="${req}$(LD_LIBRARY_PATH=$(pwd) ldd ./evelauncher | grep -i not | sed s,\\t,, | cut -d' ' -f1)"
    cd ../
    rm -rf evelauncher/
    if [ "x$req" != "x" ] ;then
	printf "\nFollowing requirements are missing:\n"
	printf "\n$req\n"
	printf "\nPlease install these requirements with your Package Manager.\n"
	printf "\nLeaving.\n\n"
	exit 0
    fi
}

prefix="/usr"
destdir="/opt/evesetup"
bindir="$destdir/bin"
libdir="$destdir/lib"
elver=""
key=""

if [ $(id -u) -ne 0 ] ;then
    printf "\nEVE Online Launcher Setup need root permissions."
    printf "\nLeaving.\n\n"
    exit 0
fi

if [ -d "$destdir" ] ;then
    printf "\n"
    read -p 'Remove EVE Online Launcher Setup? (Y/n) ' key
    [ ! "x$(echo $key | tr [:upper:] [:lower:])" = "xn" ] && \
	printf "\nRemoving...\n\n"
	bootstrap_remove
else
    printf "\n"
    read -p 'Install EVE Online Launcher Setup? (Y/n) ' key
    [ ! "x$(echo $key | tr [:upper:] [:lower:])" = "xn" ] && \
	check_req && \
	printf "\nInstalling...\n\n"
	bootstrap_install && \
	printf "\nYou can now start EVE Online Launcher and his Tools:\n\n"
	for cmd in *.desktop ;do
	    oexec=$(grep Exec= $cmd | cut -d= -f2); oexec=${oexec##*/}
	    [ ! "$oexec" = "evelauncher.sh" ] && \
	    printf " $oexec\t- $(grep Comment= $cmd | cut -d= -f2)\n"
	done
	printf "\n evelauncher.sh\t- EVE Online Launcher\n"
fi
printf "\nDone.\n\n"
