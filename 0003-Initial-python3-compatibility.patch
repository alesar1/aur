From 971d0fa65d06f59625e7f925fde8620c63f60125 Mon Sep 17 00:00:00 2001
From: enen92 <92enen@gmail.com>
Date: Fri, 3 Jan 2020 17:36:13 +0000
Subject: [PATCH 3/5] Initial python3 compatibility

---
 LICENSE                      |   0
 README.md                    |   0
 changelog.txt                |   0
 fanart.jpg                   | Bin
 icon.png                     | Bin
 resources/__init__.py        |   0
 resources/lib/__init__.py    |   0
 resources/lib/atv.py         |  10 +++++-----
 resources/lib/commonatv.py   |   4 ++++
 resources/lib/downloader.py  |  11 ++++++++---
 resources/lib/offline.py     |  11 +++++------
 resources/lib/playlist.py    |  14 ++++++++++----
 resources/lib/screensaver.py |   4 ++--
 resources/lib/trans.py       |   2 +-
 resources/settings.xml       |   0
 15 files changed, 35 insertions(+), 21 deletions(-)
 mode change 100755 => 100644 LICENSE
 mode change 100755 => 100644 README.md
 mode change 100755 => 100644 changelog.txt
 mode change 100755 => 100644 fanart.jpg
 mode change 100755 => 100644 icon.png
 mode change 100755 => 100644 resources/__init__.py
 mode change 100755 => 100644 resources/lib/__init__.py
 mode change 100755 => 100644 resources/lib/atv.py
 mode change 100755 => 100644 resources/lib/commonatv.py
 mode change 100755 => 100644 resources/lib/downloader.py
 mode change 100755 => 100644 resources/lib/offline.py
 mode change 100755 => 100644 resources/lib/playlist.py
 mode change 100755 => 100644 resources/settings.xml

diff --git a/LICENSE b/LICENSE
old mode 100755
new mode 100644
diff --git a/README.md b/README.md
old mode 100755
new mode 100644
diff --git a/changelog.txt b/changelog.txt
old mode 100755
new mode 100644
diff --git a/fanart.jpg b/fanart.jpg
old mode 100755
new mode 100644
diff --git a/icon.png b/icon.png
old mode 100755
new mode 100644
diff --git a/resources/__init__.py b/resources/__init__.py
old mode 100755
new mode 100644
diff --git a/resources/lib/__init__.py b/resources/lib/__init__.py
old mode 100755
new mode 100644
diff --git a/resources/lib/atv.py b/resources/lib/atv.py
old mode 100755
new mode 100644
index fa4b97d..75d768e
--- a/resources/lib/atv.py
+++ b/resources/lib/atv.py
@@ -21,11 +21,11 @@
 import json
 import xbmc
 import xbmcgui
-import offline as off
-import playlist
 import threading
-from commonatv import translate, addon, addon_path
-from trans import ScreensaverTrans
+from .playlist import AtvPlaylist
+from .offline import offline as off
+from .commonatv import translate, addon, addon_path
+from .trans import ScreensaverTrans
 
 monitor = xbmc.Monitor()
 
@@ -36,7 +36,7 @@ class Screensaver(xbmcgui.WindowXML):
         self.DPMStime = json.loads(xbmc.executeJSONRPC('{"jsonrpc":"2.0","method":"Settings.GetSettingValue","params":{"setting":"powermanagement.displaysoff"},"id":2}'))['result']['value'] * 60
         self.isDPMSactive = bool(self.DPMStime > 0)
         self.active = True
-        self.videoplaylist = playlist.AtvPlaylist().getPlaylist()
+        self.videoplaylist = AtvPlaylist().getPlaylist()
         xbmc.log(msg="kodi dpms time:" + str(self.DPMStime), level=xbmc.LOGDEBUG)
         xbmc.log(msg="kodi dpms active:" + str(self.isDPMSactive), level=xbmc.LOGDEBUG)
 
diff --git a/resources/lib/commonatv.py b/resources/lib/commonatv.py
old mode 100755
new mode 100644
index 878531b..1f636d3
--- a/resources/lib/commonatv.py
+++ b/resources/lib/commonatv.py
@@ -19,6 +19,7 @@
 """
 
 import os
+import sys
 import xbmcaddon
 import xbmcgui
 
@@ -32,6 +33,9 @@ places = ["All", "London", "Hawaii", "New York City", "San Francisco",
           "China", "Greenland", "Dubai", "Los Angeles", "Liwa", "Hong Kong"]
 
 
+PY3 = sys.version_info.major >= 3
+
+
 def translate(text):
     return addon.getLocalizedString(text).encode('utf-8')
 
diff --git a/resources/lib/downloader.py b/resources/lib/downloader.py
old mode 100755
new mode 100644
index 9d36813..0851cfe
--- a/resources/lib/downloader.py
+++ b/resources/lib/downloader.py
@@ -16,13 +16,18 @@
     You should have received a copy of the GNU General Public License
     along with this program.  If not, see <http://www.gnu.org/licenses/>.
 """
-import urllib2
 import xbmc
 import xbmcvfs
 import time
 import json
 import hashlib
-from commonatv import *
+
+from .commonatv import *
+
+if PY3:
+    from urllib.request import urlopen
+else:
+    from urllib2 import urlopen
 
 
 class Downloader:
@@ -71,7 +76,7 @@ class Downloader:
         xbmc.sleep(500)
         start_time = time.time()
 
-        u = urllib2.urlopen(url)
+        u = urlopen(url)
         meta = u.info()
         meta_func = meta.getheaders if hasattr(meta, 'getheaders') else meta.get_all
         meta_length = meta_func("Content-Length")
diff --git a/resources/lib/offline.py b/resources/lib/offline.py
old mode 100755
new mode 100644
index db705ca..edb8b3c
--- a/resources/lib/offline.py
+++ b/resources/lib/offline.py
@@ -17,16 +17,15 @@
     along with this program.  If not, see <http://www.gnu.org/licenses/>.
 """
 import xbmcvfs
-import playlist
-import downloader
-from commonatv import dialog, addon, translate, places
-
+from .commonatv import dialog, addon, translate, places
+from .playlist import AtvPlaylist
+from .downloader import Downloader
 
 def offline():
     if addon.getSetting("download-folder") != "" and xbmcvfs.exists(addon.getSetting("download-folder")):
         choose = dialog.select(translate(32014),places)
         if choose > -1:
-            atv_playlist = playlist.AtvPlaylist()
+            atv_playlist = AtvPlaylist()
             playlist_dict = atv_playlist.getPlaylistJson()
             download_list = []
             if playlist_dict:
@@ -39,7 +38,7 @@ def offline():
                                 download_list.append(video['url'])
             # call downloader
             if download_list:
-                down = downloader.Downloader()
+                down = Downloader()
                 down.downloadall(download_list)
             else:
                 dialog.ok(translate(32000), translate(32012))
diff --git a/resources/lib/playlist.py b/resources/lib/playlist.py
old mode 100755
new mode 100644
index 9f4ba87..692a820
--- a/resources/lib/playlist.py
+++ b/resources/lib/playlist.py
@@ -17,12 +17,18 @@
     along with this program.  If not, see <http://www.gnu.org/licenses/>.
 """
 import json
-import urllib2
 import xbmc
 import os
 import xbmcvfs
 from random import shuffle
-from commonatv import applefeed, applelocalfeed, addon
+from .commonatv import applefeed, applelocalfeed, addon, PY3
+
+if PY3:
+    from urllib.request import Request, urlopen
+else:
+    from urllib2 import urlopen
+    from urllib2.request import Request
+
 
 
 class AtvPlaylist:
@@ -30,8 +36,8 @@ class AtvPlaylist:
         if not xbmc.getCondVisibility("Player.HasMedia"):
             if addon.getSetting("force-offline") == "false":
                 try:
-                    req = urllib2.request.Request(applefeed)
-                    with urllib2.urlopen(req) as response:
+                    req = Request(applefeed)
+                    with urlopen(req) as response:
                         self.html = json.loads(response.read())
                 except Exception:
                     self.local_feed()
diff --git a/resources/lib/screensaver.py b/resources/lib/screensaver.py
index 1c60f75..8671c39 100644
--- a/resources/lib/screensaver.py
+++ b/resources/lib/screensaver.py
@@ -18,8 +18,8 @@
 """
 import xbmc
 import xbmcgui
-from trans import ScreensaverTrans
-from commonatv import translate, addon, addon_path, notification
+from .trans import ScreensaverTrans
+from .commonatv import translate, addon, addon_path, notification
 
 
 class ScreensaverPreview(xbmcgui.WindowXMLDialog):
diff --git a/resources/lib/trans.py b/resources/lib/trans.py
index a000cbd..061bd03 100644
--- a/resources/lib/trans.py
+++ b/resources/lib/trans.py
@@ -18,7 +18,7 @@
 """
 import xbmc
 import xbmcgui
-from commonatv import addon
+from .commonatv import addon
 
 
 class ScreensaverTrans(xbmcgui.WindowXMLDialog):
diff --git a/resources/settings.xml b/resources/settings.xml
old mode 100755
new mode 100644
-- 
2.29.2

