# Maintainer: Alan Orth <aorth@mjanja.ch>
pkgdesc="Header files and scripts for Clear Linux kernel and modules"
url="https://clearlinux.org/node/15538"
pkgname=linux-clear-headers-bin
# check org.clearlinux.native.X.Y.Z in Manifest
_major=5.8
_minor=10
_clr=987
pkgver=${_major}.${_minor}.${_clr}
pkgrel=1
# use in case we need to update the Arch package without incrementing pkgrel
epoch=0
arch=('x86_64')
license=('GPL2')
conflicts=("linux-clear-headers")
options=('!strip')

# see: https://cdn.download.clearlinux.org/current/latest
_clear_version=33730
_kernel_version="${_major}.${_minor}-${_clr}.native"
# hash of kernel config from Manifest.linux-dev, ie /usr/lib/kernel/config-5.3.1-843.native
# there's no way to do this automatically in the PKGBUILD
_config_hash=7cc390a851266764bc2f5a33477bce2b4b486e2caa9706b216c649c36be5404d

source=("Manifest.linux-dev.${_clear_version}::https://cdn.download.clearlinux.org/update/${_clear_version}/Manifest.linux-dev"
        "pack-linux-dev-from-0.${_clear_version}.tar::https://cdn.download.clearlinux.org/update/${_clear_version}/pack-linux-dev-from-0.tar"
        "https://cdn.download.clearlinux.org/update/${_clear_version}/files/${_config_hash}.tar"
)
b2sums=('a8c3b21b22628066c9ad063687897529e269482b0261d68e3d47b60176020336ee5b1205ad52c8fd4730cb62b7064cf18a58e1827c1c7c5f7cedc284ffa86726'
        '118ad0841583ccf3851ba8416bf06d6b5cdba4caf54a52601ca437c5f2802b03181d18fc24da86b9b791e109145159e87431cfc262090c3bf831206855f661a0'
        'd41e32abc7299b1f9b683098271215290c257ced53feedb77909c5377832c5fe60d85863ca16981abda61a60e296dec6766172cc10a11fedcd8dfe5a900c7d37')
build() {
    local files=$(sed -n -re "s/^[FL]...[[:space:]]+([a-f0-9]+)[[:space:]]+$_clear_version[[:space:]]+\/usr\/lib\/(modules.*build.*)$/\1 \2/p" Manifest.linux-dev.${_clear_version})
    local config=$(sed -n -re "s/^F.b.[[:space:]]+([a-f0-9]+)[[:space:]]+$_clear_version[[:space:]]+\/usr\/lib\/kernel\/config.*$/\1/p" Manifest.linux-dev.${_clear_version})
    local map=$(sed -n -re "s/^F.b.[[:space:]]+([a-f0-9]+)[[:space:]]+$_clear_version[[:space:]]+\/usr\/lib\/kernel\/System.map.*$/\1/p" Manifest.linux-dev.${_clear_version})

    is_path=0
    filename=''
    for line in $files; do
        if [ $is_path = 0 ]; then
            filename=$line
        else
            mkdir -p $line
            rmdir $line
            cp -P staged/$filename $line
        fi
        is_path=$(($is_path ^ 1))
    done

    mv $config modules/$_kernel_version/build/.config

    mv staged/${map} modules/$_kernel_version/build/System.map
}
package() {
    mkdir -p $pkgdir/usr/lib
    cp -Pr modules $pkgdir/usr/lib
}
b2sums=('81c21018845b0b147629e604783834397cebe03951c908ef0cdd9848ab85497e2af44af9c8af7d0f671ae7a989c39a1f69beecec990d2aa35f58dccccede4965'
        'fa31dfcbc066c845344002b65d09a4ede7c138bdd9efc5d56d634ba3a123e8a95d966bf190f3f9e354dc9f1127048b1a59df0729f56020be42e828a145f6a86c'
        '75993e378b6f46f7b8797e53053af0c94adf0ae9ae6556d4f6daec3a2fd76334eba0c42d3351d85d5a5c2b3e5c91223d5c8a951450f74903ba2dc59a8e81a53d')
b2sums=('497fe4f94955988cfcd566ff2b00770370120aa42e387d08eb15cbe86e4446e386c7bbd2f9e29957730db63669d066638b2742ecb48f1a34d6f9b77298cdc823'
        '015ecb28a8e8c835143c3e8ee69c1e1d3c73c63782e4047ec2cb0328b07b7a069b341c97c155a80a04352f730d7efda523aca9fb7ced0241ec7c90a120ab5e15'
        '02ca1844d54c6738cc7b3df88a5ff9f111f9bdebe63d64adcf8c6c395f1bd4d96c4436543c676c910fe9621c1ae5915a412e97c45b3d3add98b996526087c858')
b2sums=('8e16415c713d7435152abb98b340b97d0e56cf4c0fb4404f9e606187f3bdf5fc095f55aa8d4d3f712c2dfa3665fadf8166a23b7b61797c255fccfe978b1853d8'
        '6ce438e1d5d8eec9ab5fe514546338667eb0e2abc9af4d671b24c9c1eda5d0a02d9e6891d97bf8f4409751ec5bff9a0eb46710ac96dfd127a223b3a93aecedc0'
        '64ae29079aaa14543a1ffc9fdc214e034da6194715a31e910a0ad20faebd517cd8f3c9cb0f37326e5ed841a59ea036bd43ecdcf78a1a7b22dcaf3368664d7624')
b2sums=('897982c2f76a4f2a6b9a51428d534b74d1419310cd85dbd2ffcb95eeabf8c301aa3b22bda9a425fedcc6514f6e86e956e9aa46e7680c81875c122ea431f575ec'
        '550d97b13b2b600206b53798a172d532637b401cc7a20b2c58263132838a863aa00cd20c487df9b35adbadc2c0e7f1546285c8a761c26060b16c68e684997e0a'
        '9758bec1321608934e921c96f2b7c47509e0822951e2e188bda5ffbb5aed6b0b62ded0825d7c5330fedf7200afdb7ac355e82fa72ef3202404e217da8f645703')
b2sums=('0e2ada54d6dc6b40a58979cc756a223ab125aaaa7d0009aec0523934ed9611732b179f4291cd0fcdf0067f08142caf0c39e8aae56c3998fc5bf5ce2041c1f4f3'
        'a38c978f5852245d25978b562aa3b1aec76fc2d9ba84cfbdd569970787def9f483b8ec60f2db3fdccd9c68cc8c24202cc7ad0cc65eb72b982b1ca4946b584f76'
        '130c8882614ef8a896d3963687cc00f3a0e5b6545bad23dd69e418e2e2d007335eae86e85a28f47d8f2a351a651873dccd1e1e1306c4850948ae4bdf2ae96d0a')
b2sums=('609b665efbd3d6ef5b803854a008612766a30a6c0270281fb1359dc71ab127b14dd39245d6ce3773354386e21f2b4b38419f7d1ae873f3b7663d510cd94d50a3'
        'b4bfbf21d840b983b761a8443fc32cffdaba722632602c25c1d63b0a08ffd5023ece5b039862e9d5e3c9b6f5923c4b45507f6885bced1ac3090cd60a87a9c71c'
        '102add95d577ab5954483174f11f3ca047697d510d0566c9c3319238bd3035a7477039175691d17a1af3f4fece40601396c75a853fbec923704427a4c16db866')
b2sums=('4dc3439633c0454cf8aef40350fbd80ec6db13474e440d8588f925dc6ece9929d94034ec62855cd544ace1ddfd7863911514aba7174ca84c963cd6adc6d36a18'
        'b63717a132d172b271ab4bd8181513793cc654d66116211849cdaee1caa4e45864511109c75fa9d988a00c91beddc28d04b7f7bbe34aaabdfc062b6c14b00f0b'
        '37a9b07b7683a9a7f66222617e668eb2f200698081ce27b7d08da5c8180cb87587371fd3e30847b080de7a1228c96c9a1ef8e90dfa0e938134d21177bc8692b5')
b2sums=('1c1dbbcfcfc8614eb3ac4ba3a22ce5d479378c82cb87b3c70353311bc1d98fae8ae0281c5795c6d3faf8e4051bf39e9776ef45bcdf45bcb7a75926f15bdbf699'
        '85261238e652e9869683cd9559f3274ac2cb0c9d3fde9da00bd0354938fefdac22985843b0c6de0aefb2e553a59e455328bbf765fb4ed98bbd62596e1bfdb137'
        '3719c4164553c16f04ec02d86699240f701cf14a0c2de5d147aa108eb9e709d9ece38b4e27f857012a814639338adf83f8ecc7f0ca2e7847f48b2e9082aa7cf0')
b2sums=('4992da2ad20b99697f17eea0461da975df2a82b98ff03c007a9527f65ea7cf40f15233352b8430006fa9e084e8717b96daf83198f5530a9cb6ffa91e52eebc86'
        '75880ab2d52d1544834c5cd6b2656b2c3c4739cdb3d46c5254c3e56b2595ef7e730a8a8ac48609777838b5de36b4d87dac8c5e8a6b8abcf74db84a66164bafa5'
        '06b4ff5a559dc184aeb744211017bdc13eff410a21572557a45acf6ed16f1b30aef46bf08d3b3f47ae2ba5802983ca1d9da0db3b597ac56d7ae93c1f54e3635a')
b2sums=('e9d3f131fb899a8e5d064b07881434246623d9a7bd018aa0f0e0e7fc9b533d271fa8f60fa5743d21b8d550bcf804c7c6b1906e75ade34659f7171b21643dc953'
        'b0153d5f25bc386d230d40717bb5e96e49591911da68aaedc98a802de47d6e27ddde6eb08e08b2c9580b2530119027dd67d4e0d967566f3dd75ab90c3c031000'
        '402ba6466ccaa0a06cba93c1aa43136ccc8705a4c578b09c8e9801e2117116cacefbecfe71eb9126a63cbe62142299a543b51cfaacb972fc5b668cfbb0c12e32')
b2sums=('f07f28a579cd7e0ece8cf60c39415941c166fc5599a407051085f228b1597608366c6414e764407e2a6f151b0c91593ec83fdd36653a4af1ecdb974d1d4b2a8a'
        '78141668b016262c174c012bad563f0264ea8415afb1313272bd44ef34f2171ee088c5e7f83ee8358da5498fa7c10e534b29cb482082889d8242a73ad1bd0a60'
        '5a783e182f1dd4aa742387cc98d664a7ee1240ebe1fd0cc977a38e2f800144ce80cc5976ca6247e32aaa0ded19893c03204429130e6af39b9e0fedf69b9e02d6')
b2sums=('bc0a80c91535d31719a13c78820afefa309b4bd481b3cdf1576dce2b93d57efce556aa0225ebfb61e0d598ca6c8ac42b4645b9f4592e586239b618a682b5c328'
        '65e9bc0779e8df44373504b8ff1b182a5a1a895891e9dd5ab9f9fe57bf37f0163ca582a7fbe064532c2f83c1b85a53b696459a706d9cc17806c4db4587683d2e'
        'b7ccf0d59f36480bef2381eaaa3da196c3a6556f460c2b94aadad6692d4a0b95c1618c1bc780ba5b5ad5ff7f9ee7f63fcf65cad62f4ef094b8fdd7be7e5a0499')
b2sums=('17aeef4d3c3c63fc3ef7b4bd32dec9883986275ce7906cb01c3e1a3c8d62730c35f118551e6081aa1323eab16856c78e22f3e74995ca5b703b444a629d6c68f0'
        'df0cfb7d45c73a85d5007ff25bf897f13b89a0249fd7a29bed82a5e90a903f0a3e052d11e09cf8f103ce85e8d8d91bdbe6cfccd636b11d8124796fb2bf892050'
        '6b25abb38e1952a6c053fdfa84f0a2ec43dbbe2f25f69cab508c02cf16d8f6c2ec779fac8d71fd346bf38b37c3898224868bdb5425f76b3f867085b69578fd02')
b2sums=('eb0cb20936e43a4f61ff5c9e2db113efaf1070293e28a50a744de0e24c8c3552461866b26ad2292c61126ad721b7e116ef9e40ebcfa2ff902c5b360d198649ae'
        '013afd934ac6d9f6787c552b090f036983fc279d0efe33baeb32b2a317ee25ed32602c0dce1e923b3968048f8097d98e0975496cff838d1772ac09461a73fa5e'
        '610a24a995ae1b244f3546a39a42615aa2d45b8bbf8c168fff0ff5451a26a5281b6b0964a73cd11a815cb5e132b4e314ab4341d7b195cdd61bf1aae37346df32')
b2sums=('74d16bf92a7820c592da26269193ba46cf6f6b15d9ae5d5e5354de39922455e70051e6a247cb6c173ac74006a38a6928771b70c9f9f244a55c29366f69999b39'
        '9b5afeb63c14eff05952119223d9c757348edf119a2ae31220e7547db69e5b2e2e652c838eb23d8375058c477d855e7970d8d4aa003540ef0cf34f18f0c1bdb1'
        'e938cd5e4fa95971b0bd1b004c192ecc95fb38d67d23e726a24348fa5a6e340a5ae05b871d782d6077f05ecf9f36198148baa9f6c93ead3ea679d566228ba9e2')
b2sums=('f4f7a2f4105e9a568fc963eb428b661a822e4979ccb05de2f096495305fb676874bb0ffbae65f30497a2d780dca0fe9c1dd7f5d0acb30afa47abdf4dfaa133f2'
        '9559afc61810fd4093d884b5f87b9fdd71cc27a58c3cf0fa8061b5ce464a1b4891621d0e01723ce8dba949e4fef6c6bdb1f6968dd15e5bc225dcbf9349179dac'
        'c864f462845860c5861c26fe127c1ccbe157d2a92a76e05f90b7866a2b383996b433bde95a8c2ee9c80fffb1ed37cf615493c7e53e20c7f29f02fd742426f412')
b2sums=('e2f464e3144e62534df88f1f6884599b98a9469309be6f94eb7f1ff00b17303529e4d02f102703a9544aec3d4125804bb8fda63679b04160b8db25a59f40d6af'
        'b03ee5d2ccf30c9efebf69d05151f9f7064dc0c4aa8aa7fc701970ce26c2c9b427bf437bf1373db3bbeb194216af1f6396279354a791e43159c6f7383433b395'
        '43f12f3b4f9b64b45a5a15db1396fa05c044b7676af0aa1a4b9086005902f4450f791b23f12b7c8863010b8513765175741e60feab1efe0cfb16ab68ccec9c06')
b2sums=('863138ce7a43e996b9e816392059b4da236d09ae8214362867acc8d1f273451311529a21aa6e58ae9683a2f5c042df257007267c6a5a3a631a1db8e69d060b33'
        'af13b832840a7b9f58a2c2ef094c4e55e62b275590c8e0a24405eb81393b599ae409d2a8547e365ae00e4c7b624b1466c6d48ca90a140e92b32f2afbcebba733'
        '6b2fee6b2651abcc9432a7e5c9d83ac2cea16b7b995f768cb77ccb92f9942becb407a4c284f2904d11eee38152aee0bf6f2b4db3fdd1171d49c61b5575795bdc')
b2sums=('e3f6e1c97a17d6026cd34d5ce02777a82e44e62f05629e013cbfdd12370bddfc58951e0e19b2b3e3ec1056ce28e13ceb1c5ecb05c06471927b205aabaf7b4045'
        '42e8b5e1dfbd234b28bfbd8bfef1c4307a1abd34d6477548f389e241f9b915b5e2280f8a6e49518a2a4dde08f4c9d12217381f7fca291f89ec7c5c1edf2d6765'
        'ce6282681169a9c00de487ac3e58139818f7b18f62867ebe9c49caadc63855da777546c8c2bca59fd177107a79719974be4ca86967a71f39ea8977d3883cf729')
b2sums=('876dd91c88cc26af8a023b5ff6b97001e5f033c717ed13813eb70c5d726674ae531a30a8c625abd43766505a71a43fa78ac18e0671e0ed66c1b917b21e074821'
        'd399934ffe2a354aade93ea6a9afb03c12a7acf37024d5c9ef9d1930b3bb3d5259e2226d1245fa63464be19ab2c770b53ede672d0a3e3ef17dfca9262306295a'
        'bc2738b49c2f17f3447ea7821a09da380dd8b68dff2462213ef50e8ce91e9a117bfc978af3fdd4925a9b4ced3b1a1b3df8d16f37ecb62d1d215dce8fba8e34d0')
b2sums=('e986bf571191108ff9711b4114deb03755f2fe0a8f6f8ad0bedb61baab31be721838d64c398377701fe5e1f4960c7a50b93c28440c378d80496b3f41d9e0a15d'
        '51526a44db53815d026f8fc24092c64fdbba678131ec8a8aeedf1c74599279b9040e701ed603d2d4efcb421989876aa9f75a395e2a5df83dff848360d7ef03f6'
        'bd8b24f921990edf657f12db7bc42eed0db36b57db85841b95da27cfc7facdf3d7ed290ea9a323c46df5caf4662dc694344800bde99c503c7fa96df692adfc7b')
b2sums=('8e494f15d33ab821ab0424295e410d01facad44b31d8f566847f73b189cea142e9804c90a3e654444cff2a3003898fa838d37f371b76f1a2bf626bab471cd017'
        'b098d60c80f5423b1123c9072067d58dd7abfde94dc65d64b8b86b466bde73ec08433924a3af65bcfb2ae3a07906f618de4c3a41225700bd737282ccb014e089'
        '00c8ae687e92b5da2818f9fe3795aa1ce5a4f55de47ea821d8d9a8df521662e0b47004b6062bd4a4e97014ac45324656cb049258b1fb1c0dc1d10d40305f6aae')
b2sums=('02fb305dd54f52e5e54163b89b1d4528c993c62ecddcf639d20dd59fe1293b9f205ce78d4991dc89521529ef40eb75ff1239397cd983bf13fbd6089809a84fcc'
        '00bbf1f3dc897e80a8a25a99f3dfb57c8711072f051b4b64affe1eeb2018a2d375ffd40e8cd1be9014e1a48a629045193346643b20966f641885d2e0e8a5b604'
        '24069cbe1938152d97e58694516e2fbb7562e093c5dd93bd30f29455eb56fd1cf9759cc69b0e61a09e7502ac14a1c3c3f348bc6e654104d80a4397d24dcf6faf')
b2sums=('78ef228426a0fec67511d1f6c69806e25a4781ded4e497d2f37262dd626dc547638f8e5742845d01ea57e5e125da1b01774a4f39604d9178c82d1542991868c5'
        '9fefd3ac5b09846826c88ac6370f45be25e0c328c7388c3de9898d0e6c5352d077541b3288e03768de08ba9200e04e6f1469478bc7e9396a56b47ff823490634'
        '8470b34c22b1d66f9381335972a4e89feb4873d373675b16332feae7611f81e92cd54e525537213fd900e95538ece3138d3704b7a863c5b7e84f88351d4a985d')
b2sums=('98eb153138b5242a1b684a83dcdbdacb59940555dba4c82afba2cd2dd2c6adb167d829cad48d26017f003f433dc7e7329c354c7e3fad0f2ca87950309663e43e'
        'bec00e4fa17deb9cca72b604677aad881a13bde50e95c561271bd002264b2fa5316103d3c34567a7e6eb8367e60680cf369f98ef813f87a93fda6386df4faa30'
        'c5d8f6bdeec092cda543b90d1c0cffb6d9f0dcc332c2417ceafe0a113d8e977bdbabb8b898c9440cfcc80796538d84282c1a1cc5e927b140ab0d4c731f07a1d6')
b2sums=('2f5d7168c4b2451072889df3692813f5d3e9fa88dea8f9b1eab5b65941179909261cc0f9e30ee4a3fb54536b8181b07613c6b6d072fd72d58340a70cbff5b771'
        'c69fcd1c2a71cb5d9586cdf619064a0682d61f393b07cbf60bfd80afe49a7a0e317ea70587f4a8b7319b9e6440575ec47fb38cfea36afba40a2ef3e9e08296df'
        '8ed1e5579945bdd5c5a530e5552fd9237b89ed5752619e28f963c46b955fb3462126d44f6e92c62325965225e10c2902348c83cb7899b4284ae2316c262f2645')
b2sums=('1a04b89ef3c265d7f7a6e70d65cd6912f3537d912e4b3ace9ece94fae8b4b8185d315d07d378087a64caaa01f5b630a395b47e46a95d7bff15e96b49cb4ac21c'
        '1bfa6fb18d8c8594ec9989e69073e54d5a3896ec03ae7ef554d95f055f2ceedff8c3e260391e3eb8e6d5e6c86c6a3e06d8cf1ba9dc651bc34f0f97ff5c980415'
        '240dbd6cce36b55530c913a7792e5f982f9a7c8522eeb60e6a26a0a25c1610cf8001f0c9136808eda3000154661702906666e6a4219045386454eae3b2682c07')
b2sums=('48d8c2019bc463dc9504e6cbbc5ca9f694d6c7cafb68db094cb9f3427c6b4cb6edfb7d7baaffa54dd5796800b94771e18a41078e37d552ff889812cb26872dd7'
        'aec208f5b67582f05b809b75eeac251b3719cbabd580cf49e3ac4cc7d88dcaffbefbb6a98b0047b6f238487cff67406a4a8bf8c0a15f0091b832e72d24886a6a'
        'b1a3b3dbe1789c82cdc2b259b69a0b068a5abc8027081536011b52f813ee169ccaab9dbae337d15932bfcc73fc498d819af87573efdae17697735a678dab589d')
