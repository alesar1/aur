# Maintainer: Adrian Perez de Castro <aperez@igalia.com>
pkgname=openradtool
pkgdesc='Generator for front-end and back-end code for Web applications written in C'
pkgver=0.14.0
pkgrel=1
url=https://kristaps.bsd.lv/openradtool
license=(custom:BSD)
makedepends=(bc bmake)
depends=(expat)
conflicts=(kwebapp)
replaces=(kwebapp)
optdepends=('sqlbox: Needed by code generated by openradtool')
arch=('x86_64')
source=("${url}/snapshots/openradtool-${pkgver}.tar.gz" makefile-ldflags.patch)
b2sums=('efde1e376447997fcd77cd2b393abc7b23ad87d7a6ee30c2c6230b9a1f5885dfe6d4014b1146797c34e17a84cbe2fb731454990bff5373fc21c0acea6f664643'
        '26b4baa33c8722026555f5d4896449e108c87bce8bcc9ef2db13fde4ec5143c21e57b3d22e097d472654b1fd3839c34662105f0c307148dcdcfba86014eb22bd')

prepare () {
	cd "${pkgname}-${pkgver}"
	patch -p1 < "${srcdir}/makefile-ldflags.patch"
}

build () {
	cd "${pkgname}-${pkgver}"
	CFLAGS="${CFLAGS}" ./configure PREFIX=/usr MANDIR=/usr/share/man LDFLAGS="${LDFLAGS}"
	chmod +w ort-version.h
	bmake
}

check () {
	bmake -C "${pkgname}-${pkgver}" -j1 regress
}

package () {
	cd "${pkgname}-${pkgver}"
	bmake install DESTDIR="${pkgdir}"
	strip -x --strip-unneeded "${pkgdir}"/usr/bin/ort*
	awk '/^\/\*/,/\*\// { print ; }' main.c > COPYING
	install -Dm644 COPYING "${pkgdir}/usr/share/licenses/${pkgname}/COPYING"
}
