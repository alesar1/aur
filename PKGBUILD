# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
# Maintainer: Rudi [KittyCash] <rudi@skycoinmail.com>
projectname=skycoin
pkgname=skycoin-explorer
pkgname1=skycoin
pkgdesc="Skycoin Blockchain Explorer. explorer.skycoin.net"
pkgver='autogenerated'
pkggopath="github.com/$projectname/$pkgname"
pkgrel=1
arch=('any')
url="https://${pkggopath}"
license=()
makedepends=(git go gcc npm)
source=("git+${url}.git#branch=${BRANCH:-develop}")
sha256sums=('SKIP')
validpgpkeys=('DE08F924EEE93832DABC642CA8DC761B1C0C0CFC')

pkgver() {
cd "$srcdir/$pkgname"
local date=$(git log -1 --format="%cd" --date=short | sed s/-//g)
local count=$(git rev-list --count HEAD)
local commit=$(git rev-parse --short HEAD)
echo "$date.${count}_$commit"
}

export GOOS=linux
export GOPATH="$srcdir"
export GOROOT="$builddir"
export GOBIN="$GOROOT"/bin
export GOROOT_FINAL=/usr/lib/go

export CGO_ENABLED=0

case "$CARCH" in
x86)      export GOARCH="386" GO386="387" ;;
x86_64)   export GOARCH="amd64" ;;
arm*)     export GOARCH="arm" ;;
armel)    export GOARCH="arm" GOARM="5" ;;
armhf)    export GOARCH="arm" GOARM="6" ;;
armv7)    export GOARCH="arm" GOARM="7" ;;
armv8)    export GOARCH="arm64" ;;
aarch64)  export GOARCH="arm64" ;;
mips)     export GOARCH="mips" ;;
mips64)   export GOARCH="mips64" ;;
mips64el) export GOARCH="mips64le" ;;
mipsel)   export GOARCH="mipsle" ;;
*)        return 1 ;;
esac

build () {
msg2 'installing go dependencies'
export GOPATH="$srcdir"/go
export GOBIN=${GOPATH}/bin
export PATH=${GOPATH}/bin:${PATH}

mkdir -p $srcdir/go/src/${pkggopath//$pkgname/} $srcdir/go/bin

ln -rTsf $srcdir/$pkgname $srcdir/go/src/$pkggopath
cd $srcdir/go/src/$pkggopath/
git checkout develop
git submodule --quiet update --init --recursive
rm -rf Gopkg.toml
rm -rf Gopkg.lock
go install \
-gcflags "all=-trimpath=${GOPATH}" \
-asmflags "all=-trimpath=${GOPATH}" \
-ldflags "-extldflags $LDFLAGS" \
-v ./...
#build the UI
npm install
npm audit fix
npm install --save-dev @angular-devkit/build-angular
make build-ng

}


package() {
options=(!strip staticlibs)
#create directory trees
mkdir -p $pkgdir/usr/bin
mkdir -p $pkgdir/usr/lib/$projectname/go/bin
mkdir -p $pkgdir/usr/lib/$projectname/$pkgname/
#restate go envs
export GOPATH=$pkgdir/usr/lib/$projectname/go
export GOBIN=$pkgdir/usr/lib/$projectname/go/bin
#install binaries & symlink to /usr/bin
msg2 'installing binaries'
skybins="$srcdir"/go/bin
potentialnameconflicts=$( ls --ignore=skycoin* "$skybins")
cd $skybins
for i in $potentialnameconflicts; do
mv $skybins/$i $skybins/$pkgname1-$i
done
#create the launcher script
echo -e '#!/bin/bash \n #launch skycoin explorer more easily \n export GOBIN=/usr/lib/skycoin/go/bin \n export GOPATH=/usr/lib/skycoin/go \n export GOBIN=$GOPATH/bin \n nohup skycoin -gui-dir=/usr/lib/skycoin/skycoin/src/gui/static/ -launch-browser=true -enable-all-api-sets=true -enable-gui=true -rpc-interface=false -log-level=debug > /dev/null 2>&1 &cd /usr/lib/skycoin/skycoin-explorer \n echo "Please enter the port that skycoin wallet is running on:" \n read port \n SKYCOIN_ADDR=http://127.0.0.1:$port skycoin-explorer' > $pkgname-launch
chmod +x $pkgname-launch
skycoinbins=$( ls "$skybins")
for i in $skycoinbins; do
install -Dm755 $srcdir/go/bin/$i $pkgdir/usr/lib/$projectname/go/bin/$i
ln -rTsf $pkgdir/usr/lib/$projectname/go/bin/$i $pkgdir/usr/bin/$i
chmod 755 $pkgdir/usr/bin/$i
done
cp -r $srcdir/$pkgname/ $pkgdir/usr/lib/$projectname/
}
