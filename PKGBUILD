# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
_pkgname1=tesla
_pkgname=skycoin
pkgname=tesla
_githuborg1=the-skycoin-project
_githuborg=skycoin
pkgdesc="Tesla Cryptocurrency Wallet. Example cryptocurrency built with skycoin"
pkgver='autogenerated'
#pkgver='autogenerated'
pkgrel=1
#pkgrel=2
arch=('x86_64' 'aarch64' 'armv8' 'armv7' 'armv7l' 'armv7h' 'armv6h' 'armhf' 'armel' 'arm')
_pkggopath="github.com/${_githuborg}/${_pkgname}"
_pkggopath1="github.com/${_githuborg1}/${_pkgname1}"
url="https://${_pkggopath}"
url1="https://${_pkggopath1}"
makedepends=('git' 'go' 'musl' 'kernel-headers-musl')
depends=('skycoin')
source=("git+${url1}.git" ##branch=${BRANCH:-develop}"
#"git+${url}.git" ##branch=${BRANCH:-develop}"
"tesla-wallet.sh")
sha256sums=('SKIP'
#            'SKIP'
            '23babd4af4ebdff1fb914161bcec54cfa9307a5f26fc74ae388f5b131335efb2')

#tar -czvf privatetesla-scripts.tar.gz privatetesla-scripts
#updpkgsums

pkgver() {
		cd "${srcdir}/${_pkgname}"
		local date=$(git log -1 --format="%cd" --date=short | sed s/-//g)
		local count=$(git rev-list --count HEAD)
		local commit=$(git rev-parse --short HEAD)
		echo "$date.${count}_$commit"
	}

	prepare() {
		#verify PKGBUILD signature
		#gpg --verify ${srcdir}/PKGBUILD.sig ../PKGBUILD
		mkdir -p ${srcdir}/go/src/github.com/${_githuborg}/ ${srcdir}/go/bin
		ln -rTsf ${srcdir}/${_pkgname1} ${srcdir}/go/src/${_pkggopath}
	}

build() {
	export GOPATH=${srcdir}/go
	export GOBIN=${GOPATH}/bin
  export CC=musl-gcc
  export CGO_ENABLED=1
#  [[ -f ${srcdir}/${_pkgname}/fiber.toml ]] && mv ${srcdir}/${_pkgname}/fiber.toml ${srcdir}/${_pkgname}/fiber.toml.bak
#  cp ${srcdir}/fiber.toml ${srcdir}/${_pkgname}/fiber.toml
#	_cmddir=${srcdir}/go/src/${_pkggopath}/cmd
#cd ${srcdir}/go/src/${_pkggopath}/
#skycoin-newcoin createcoin --coin ${_pkgname1}
#  _buildbins address_gen
  _buildbins tesla
 #binary transparency
	cd $GOBIN
	_msg2 'binary sha256sums'
	sha256sum $(ls)
}

_buildbins() {

_binname=$1
_msg2 "building ${_binname} binary"
#SPEED UP TESTING OF BUILDS
#if [[ ! -f ${GOBIN}/${_binname} ]] ; then
	cd ${_cmddir}/${_binname}
  go build -trimpath --ldflags '-linkmode external -extldflags "-static" -buildid=' -o $GOBIN/ .
#fi
}

package() {
	#create directory trees
	_teslasrcdir=${srcdir}/${_pkgname1}
	_teslapath=${pkgdir}/opt/${_pkgname1}
	_teslagobin=${_teslapath}/bin
	_teslaguidir=${_teslapath}/src/gui
	mkdir -p ${pkgdir}/usr/bin
	mkdir -p ${_teslagobin}
	mkdir -p ${_teslaguidir}
	#install binaries & symlink to /usr/bin
	_msg2 'installing binaries'
	_teslabin="${srcdir}"/go/bin
	#collect the binaries & install
	_teslabins=$( ls "$_teslabin")
	for i in $_teslabins; do
		install -Dm755 ${srcdir}/go/bin/${i} ${_teslagobin}/${i}
		ln -rTsf ${_teslagobin}/$i ${pkgdir}/usr/bin/${i}
		chmod 755 ${pkgdir}/usr/bin/${i}
	done
  _msg2 'installing gui sources'
	#install the web dir (UI)
	cp -r ${_teslasrcdir}/src/gui/static ${_teslaguidir}
  _msg2 'installing scripts'
	#install the scripts
	#_teslascripts=$( ls --ignore=*.service ${srcdir}/${_pkgname}-scripts/ )
	#for i in $_teslascripts; do
		install -Dm755 ${srcdir}/tesla-wallet.sh ${_teslagobin}/tesla-wallet
		ln -rTsf ${_teslagobin}/tesla-wallet ${pkgdir}/usr/bin/tesla-wallet
		chmod 755 ${pkgdir}/usr/bin/tesla-wallet
	#done
  #_msg2 'installing systemd services'
  #install the system.d service
  #  install -Dm644 ${srcdir}/${_pkgname}-scripts/${_pkgname}-node.service ${pkgdir}/usr/lib/systemd/system/${_pkgname}-node.service
}

_msg2() {
(( QUIET )) && return
local mesg=$1; shift
printf "${BLUE}  ->${ALL_OFF}${BOLD} ${mesg}${ALL_OFF}\n" "$@"
}
