#!/usr/bin/env bash
set -euo pipefail

#Use settings from the configuration file first.
source '/etc/update-pacman-mirrorlist' || true

help='Usage: update-pacman-mirrorlist [OPTIONS]

Updates the pacman mirrorlist.

Options:
-h | --help		Print this help message then exit.
-l | --local FILE	Download new mirrorlist to FILE.
-r | --remote URL	Download new mirrorlist from URL.

Configuration files:
/etc/update-pacman-mirrorlist'

set +u
	#Prefer settings from the command line arguments.
	set +e
		options=$(getopt -o 'hl:r:' -l 'help,local:,remote:' -n 'update-pacman-mirrorlist' -- "$@")
		if [ "$?" != 0 ]; then
			echo "$help"
			exit 64 #EX_USAGE
		fi
	set -e
	eval set -- "$options"
	while true; do
		case "$1" in
		-h | --help ) echo "$help"; exit 0 ;; #EX_OK
		-l | --local ) local_mirrorlist="$2"; shift 2 ;;
		-r | --remote ) remote_mirrorlist="$2"; shift 2 ;;
		-- ) shift; break ;;
		* ) break ;;
		esac
	done

	#Fall back to defaults if the settings are not defined in the configuration file or command line arguments.
	if [ -z "$local_mirrorlist" ]; then
		local_mirrorlist='/etc/pacman.d/mirrorlist'
	fi
	if [ -z "$remote_mirrorlist" ]; then
		remote_mirrorlist='https://www.archlinux.org/mirrorlist/?use_mirror_status=on&protocol=https'
	fi
set -u

temp_local_mirrorlist="$(mktemp)" || exit 73 #EX_CANTCREAT
trap 'rm -f "$temp_local_mirrorlist"' EXIT

echo "Downloading new mirrorlist from $remote_mirrorlist to $local_mirrorlist."
curl -fLC - --retry 9 "$remote_mirrorlist" -o "$temp_local_mirrorlist" || exit 69 #EX_UNAVAILABLE

if grep -Eqv '^(#|\s+#|$|Server = )' "$temp_local_mirrorlist"; then
	echo 'The downloaded mirrorlist file contains an uncommented non-Server directive, so it might be invalid.' >&2
	exit 65 #EX_DATAERR
fi

if ! grep -q '^Server = ' "$temp_local_mirrorlist"; then
	if ! grep -q '^#Server = ' "$temp_local_mirrorlist"; then
		echo 'The downloaded mirrorlist file does not appear to contain any mirrors, so it might be invalid.' >&2
		exit 65 #EX_DATAERR
	fi
	sed '/^#Server = / s|#||' -i "$temp_local_mirrorlist"
fi

cat "$temp_local_mirrorlist" > "$local_mirrorlist" || exit 73 #EX_CANTCREAT
