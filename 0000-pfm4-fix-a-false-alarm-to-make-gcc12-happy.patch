--- pfmlib_perf_event_pmu.c	2020-04-03 09:07:00.000000000 +0100
+++ patched.c	2022-05-16 22:23:47.498796041 +0100
@@ -254,18 +254,20 @@ static perf_event_t *
 perf_table_alloc_event(void)
 {
 	perf_event_t *new_pe;
+	long perf_pe_used;
 
 retry:
 	if (perf_pe_free < perf_pe_end)
 		return perf_pe_free++;
 
+	perf_pe_used = perf_pe_free - perf_pe;
 	perf_pe_count += PERF_ALLOC_EVENT_COUNT;
 	
 	new_pe = realloc(perf_pe, perf_pe_count * sizeof(perf_event_t));
 	if (!new_pe) 
 		return NULL;
 	
-	perf_pe_free = new_pe + (perf_pe_free - perf_pe);
+	perf_pe_free = new_pe + perf_pe_used;
 	perf_pe_end = perf_pe_free + PERF_ALLOC_EVENT_COUNT;
 	perf_pe = new_pe;
 
@@ -290,18 +292,20 @@ static perf_umask_t *
 perf_table_alloc_umask(void)
 {
 	perf_umask_t *new_um;
+	long perf_um_used;
 
 retry:
 	if (perf_um_free < perf_um_end)
 		return perf_um_free++;
 
+	perf_um_used = perf_um_free - perf_um;
 	perf_um_count += PERF_ALLOC_UMASK_COUNT;
 	
 	new_um = realloc(perf_um, perf_um_count * sizeof(*new_um));
 	if (!new_um) 
 		return NULL;
 	
-	perf_um_free = new_um + (perf_um_free - perf_um);
+	perf_um_free = new_um + perf_um_used;
 	perf_um_end = perf_um_free + PERF_ALLOC_UMASK_COUNT;
 	perf_um = new_um;
 
