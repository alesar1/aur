#!/bin/bash

build() {
    add_module aoe
    
    add_udev_rule '65-aoe.rules'

    add_binary "/usr/bin/aoe-discover" "/bin/aoe-discover"

    add_runscript

    cat >"$BUILDROOT/usr/lib/systemd/system/aoe.service" <<EOF
[Unit]
Description=AoE startup
After=systemd-modules-load.service
Before=initrd-root-device.target
DefaultDependencies=no

[Service]
Type=idle
RemainAfterExit=yes
ExecStartPre=/usr/bin/modprobe aoe
ExecStart=/hooks/aoe run_hook
EOF

    cd "$BUILDROOT/usr/lib/systemd/system/sysinit.target.wants"
    ln -sf ../aoe.service aoe.service
}

help() {
    cat <<HELPEOF
This hook loads the necessary modules for a AoE device.
Detection will take place at runtime. To minimize the modules
in the image, add the autodetect hook too.
HELPEOF
}

# vim: set ft=sh ts=4 sw=4 et:
