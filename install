#!/bin/bash

# care about existing files
function installdir() {
    local owner="$1"
    local moddir="$2"
    local modfile="$3"
    local directory="$4"
    
    mkdir -p "$directory"
    find $directory -exec chown "$owner" {} \;
    find $directory -type f -exec chmod "$modfile" {} \;
    find $directory -type d -exec chmod "$moddir" {} \;
}

function installbasics() {
    # create tempdirs and users from /usr/lib/*.d
    systemd-sysusers
    systemd-tmpfiles --create

    installdir zarafa:zarafa 0700 0600 /var/log/zarafa
    installdir zarafa:zarafa 0700 0600 /var/lib/zarafa
    installdir zarafa:zarafa 0700 0600 /var/lib/zarafa/search
    installdir zarafa:zarafa 0700 0600 /var/lib/zarafa/presence
    
    # due to a bug/exception it's impossible to execute phps mapi modul without browsable dir
    installdir zarafa:zarafa 0755 0600 /etc/zarafa
  
    # fix missing python symlink for presence
    if [[ ! -e "/usr/bin/python" ]];
    then
	ln -s /usr/bin/python2 /usr/bin/python
    fi    
}

post_install() {
    installbasics

    # CONFIG
    # => defaults
    for cfg in /usr/share/doc/zarafa/example-config/*.cfg; do
	install --backup=simple --suffix .pacsave -o zarafa -g zarafa -m 0600  ${cfg} /etc/zarafa
    done
  
    echo
    echo "Please install Zarafa:"
    echo
    echo "   $ /usr/share/doc/zarafa/install.sh"
    echo 
    echo "Read More"
    echo
    echo "   https://wiki.archlinux.org/index.php/MySQL"
    echo "   https://pietma.com/run-and-access-zarafa/"
    echo "   https://pietma.com/optimize-zarafa-and-mysql-mariadb/"
    echo

    return 0
}

post_upgrade() {
    local newPackageVersion="$1"
    local oldPackageVersion="$2"

    case "$oldPackageVersion" in
	7.2.1*)
    	    installbasics

            # CONFIG
	    # => defaults
    	    for cfg in /usr/share/doc/zarafa/example-config/*.cfg; do
		install --backup=simple -o zarafa -g zarafa -m 0600 ${cfg} /etc/zarafa
	    done

	    echo "Please check /etc/zarafa for new configuration values!"
	    ;;
	*)
	    ;;	
    esac
    
    return 0
}

pre_remove() {
    return 0
}
