From 5b3e7b7f583df39d0fa3a01a95ad8c6dd65b70e2 Mon Sep 17 00:00:00 2001
From: Dominik Csapak <dominik.csapak@gmail.com>
Date: Wed, 15 Jul 2020 07:37:24 +0000
Subject: [PATCH 1/2] adapt cargo toml and remove systemd linking

use crates.io (not a local repository) and use the
git repositories for the proxmox dependencies

also remove the system linking attribute, else rust links
it also in, even if the proxmox-backup-client and pxar does not use it

Signed-off-by: Dominik Csapak <dominik.csapak@gmail.com>
---
 .cargo/config       | 5 -----
 Cargo.toml          | 8 ++++----
 src/tools/daemon.rs | 2 --
 3 files changed, 4 insertions(+), 11 deletions(-)
 delete mode 100644 .cargo/config

diff --git a/.cargo/config b/.cargo/config
deleted file mode 100644
index 3b5b6e48..00000000
--- a/.cargo/config
+++ /dev/null
@@ -1,5 +0,0 @@
-[source]
-[source.debian-packages]
-directory = "/usr/share/cargo/registry"
-[source.crates-io]
-replace-with = "debian-packages"
diff --git a/Cargo.toml b/Cargo.toml
index 283453e7..29db166d 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -52,14 +52,14 @@ pam-sys = "0.5"
 percent-encoding = "2.1"
 pin-utils = "0.1.0"
 pin-project = "1.0"
-pathpatterns = "0.1.2"
-proxmox = { version = "0.11.5", features = [ "sortable-macro", "api-macro" ] }
+pathpatterns = { version = "0.1.2", git = "git://git.proxmox.com/git/pathpatterns.git" }
+proxmox = { version = "0.11.5", features = [ "sortable-macro", "api-macro" ], git = "git://git.proxmox.com/git/proxmox.git", rev = "47e6ae52ff070bfa85c6a487a7db6095efedc018" }
 #proxmox = { git = "git://git.proxmox.com/git/proxmox", version = "0.1.2", features = [ "sortable-macro", "api-macro" ] }
 #proxmox = { path = "../proxmox/proxmox", features = [ "sortable-macro", "api-macro" ] }
-proxmox-fuse = "0.1.1"
-proxmox-http = { version = "0.2.1", features = [ "client", "http-helpers", "websocket" ] }
+proxmox-fuse = { version = "0.1.1", git = "git://git.proxmox.com/git/proxmox-fuse.git" }
+proxmox-http = { version = "0.2.1", features = [ "client", "http-helpers", "websocket" ], git = "git://git.proxmox.com/git/proxmox.git", rev = "fff7b926eee01462a047444bfe61649741ed1a44" }
 #proxmox-http = { version = "0.2.0", path = "../proxmox/proxmox-http", features = [ "client", "http-helpers", "websocket" ] }
-pxar = { version = "0.10.1", features = [ "tokio-io" ] }
+pxar = { version = "0.10.1", features = [ "tokio-io" ] , git = "git://git.proxmox.com/git/pxar.git", rev = "b203d38bcd399f852f898d24403f3d592e5f75f8"}
 #pxar = { path = "../pxar", features = [ "tokio-io" ] }
 regex = "1.2"
 rustyline = "7"
diff --git a/src/tools/daemon.rs b/src/tools/daemon.rs
index 6bb4a41b..9b358d78 100644
--- a/src/tools/daemon.rs
+++ b/src/tools/daemon.rs
@@ -19,7 +19,6 @@ use proxmox::tools::io::{ReadExt, WriteExt};
 use crate::server;
 use crate::tools::{fd_change_cloexec, self};
 
-#[link(name = "systemd")]
 extern "C" {
     fn sd_journal_stream_fd(identifier: *const c_uchar, priority: c_int, level_prefix: c_int) -> c_int;
 }
@@ -335,7 +334,6 @@ async fn wait_service_is_active(service: &str) -> Result<(), Error> {
     }
 }
 
-#[link(name = "systemd")]
 extern "C" {
     fn sd_notify(unset_environment: c_int, state: *const c_char) -> c_int;
 }
-- 
2.29.2

