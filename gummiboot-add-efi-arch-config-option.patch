From 6a4562a11ebe643779cd19fab7b5870d78e90bd6 Mon Sep 17 00:00:00 2001
From: Keshav Amburay <the.ridikulus.rat@gmail.com>
Date: Tue, 22 Apr 2014 21:46:18 -0400
Subject: [PATCH] Add new config file keyword 'efi-arch' to specify the ARCH of
 the EFI image

---
 src/efi/gummiboot.c | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/efi/gummiboot.c b/src/efi/gummiboot.c
index d405453..b403231 100644
--- a/src/efi/gummiboot.c
+++ b/src/efi/gummiboot.c
@@ -846,7 +846,7 @@ static BOOLEAN menu_run(Config *config, ConfigEntry **chosen_entry, EFI_FILE *ro
                         break;
 
                 case KEYPRESS(0, 0, 'v'):
-                        status = PoolPrint(L"gummiboot " VERSION ", UEFI %d.%02d, %s %d.%02d",
+                        status = PoolPrint(L"gummiboot " VERSION ", UEFI Spec. %d.%02d, ARCH " MACHINE_TYPE_NAME ", %s %d.%02d",
                                            ST->Hdr.Revision >> 16, ST->Hdr.Revision & 0xffff,
                                            ST->FirmwareVendor, ST->FirmwareRevision >> 16, ST->FirmwareRevision & 0xffff);
                         break;
@@ -1149,6 +1149,21 @@ static VOID config_entry_add_from_file(Config *config, EFI_HANDLE *device, CHAR1
                         continue;
                 }
 
+                if (strcmpa((CHAR8 *)"efi-arch", key) == 0) {
+                        CHAR16 *gummiboot_arch = NULL;
+                        CHAR16 *loader_arch = NULL;
+
+                        gummiboot_arch = stra_to_str((CHAR8 *)MACHINE_TYPE_NAME);
+                        loader_arch = stra_to_str(value);
+
+                        /* do not add an entry for wrong EFI arch image */
+                        if (StriCmp(gummiboot_arch, loader_arch) != 0) {
+                                entry->type = LOADER_UNDEFINED;
+                                break;
+                        }
+                        continue;
+                }
+
                 if (strcmpa((CHAR8 *)"initrd", key) == 0) {
                         CHAR16 *new;
 
-- 
1.9.2

