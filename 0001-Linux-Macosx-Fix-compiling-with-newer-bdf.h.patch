From 3247072ca0edabd0bfb2523efc19d14e22bbe467 Mon Sep 17 00:00:00 2001
From: Kjetil Matheussen <k.s.matheussen@notam02.no>
Date: Fri, 6 Mar 2020 14:19:16 +0100
Subject: [PATCH 1/9] Linux/Macosx: Fix compiling with newer bdf.h

---
 crashreporter/backtrace-symbols.c | 30 ++++++++++++++++++++++++++++--
 1 file changed, 28 insertions(+), 2 deletions(-)

diff --git a/crashreporter/backtrace-symbols.c b/crashreporter/backtrace-symbols.c
index 0ee3a43f..39370358 100644
--- a/crashreporter/backtrace-symbols.c
+++ b/crashreporter/backtrace-symbols.c
@@ -57,6 +57,16 @@ Downloaded from http://opensource.apple.com/source/X11libs/X11libs-40.2/cairo/ca
 //#if defined(FOR_LINUX)
 //#  include <libiberty.h> // mac ports doesn't install this file.
 //#endif
+
+#if defined(bfd_get_section_flags)
+#define OLD_BFD_VERSION 1
+#define NEW_BFD_VERSION 0
+#else
+#define OLD_BFD_VERSION 0
+#define NEW_BFD_VERSION 1
+#endif
+
+
 #include <dlfcn.h>
 #include <link.h>
 #if 0
@@ -133,17 +143,33 @@ static void find_address_in_section(bfd *abfd, asection *section, void *data __a
 	if (found)
 		return;
 
-	if ((bfd_get_section_flags(abfd, section) & SEC_ALLOC) == 0)
+#if NEW_BFD_VERSION
+        
+	if ((bfd_section_flags(section) & SEC_ALLOC) == 0)
+		return;
+        
+	vma = bfd_section_vma(section);
+	if (pc2 < vma)
+		return;
+        
+	size = bfd_section_size(section);
+	if (pc2 >= vma + size)
 		return;
 
+#else
+	if ((bfd_get_section_flags(abfd, section) & SEC_ALLOC) == 0)
+		return;
+        
 	vma = bfd_get_section_vma(abfd, section);
 	if (pc2 < vma)
 		return;
-
+        
 	size = bfd_section_size(abfd, section);
 	if (pc2 >= vma + size)
 		return;
 
+#endif
+        
 	found = bfd_find_nearest_line(abfd, section, syms, pc2 - vma,
 				      &filename, &functionname, &line);
 }
-- 
2.26.2

