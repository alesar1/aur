#!/bin/bash

_update()
{
	cd kicad
	git fetch
	cd ../kicad-i18n
	git fetch
	cd ..
}

_kicadRawVersion()
{
	cd kicad
	git describe --tag
	cd ..
}

_kicadVersion()
{
	_kicadRawVersion | sed 's/-/_/g'
}

_kicadHash()
{
	cd kicad
	git rev-parse --short master
	cd ..
}

_i18nHash()
{
	cd kicad-i18n
	git rev-parse --short master
	cd ..
}

_buildPKGBUILD()
{
	sed -e "s/@KICAD_VERSION@/$(_kicadVersion)/" \
		-e "s/@KICAD_HASH@/$(_kicadHash)/" \
		-e "s/@I18N_HASH@/$(_i18nHash)/" \
		PKGBUILD.in > PKGBUILD
}

_updateSRCINFO()
{
	makepkg --printsrcinfo > .SRCINFO
}

_update
_buildPKGBUILD
_updateSRCINFO
version=`_kicadRawVersion`

git add PKGBUILD .SRCINFO
git commit -m "Bump to KiCAD $version"
echo $version
