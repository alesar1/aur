diff --git a/common/avdecoder.cpp b/common/avdecoder.cpp
index d4ff140..3216eaa 100644
--- a/common/avdecoder.cpp
+++ b/common/avdecoder.cpp
@@ -141,7 +141,7 @@ AVFrame *AVDecoder::getDecodedFrame(AVCodecContext *codec_ctx, int frame_stream_
         if(packet.stream_index == frame_stream_index) {
             avcodec_decode_video2(codec_ctx, pFrame, &frame_finished, &packet);
         }
-        av_free_packet(&packet);
+        av_packet_unref(&packet);
     }
 
     if(frame_finished) {
@@ -239,7 +239,7 @@ QByteArray AVDecoder::WriteJPEG(AVCodecContext *pCodecCtx, AVFrame *pFrame, int
                 pCodecCtx->width, pCodecCtx->height,
                 pCodecCtx->pix_fmt,
                 width, height,
-                PIX_FMT_YUVJ420P, SWS_BICUBIC,
+                AV_PIX_FMT_YUV420P, SWS_BICUBIC,
                 NULL, NULL, NULL);
 
     if(!sws_ctx) {
@@ -257,7 +257,7 @@ QByteArray AVDecoder::WriteJPEG(AVCodecContext *pCodecCtx, AVFrame *pFrame, int
         return data;
     }
 
-    int numBytes = avpicture_get_size(PIX_FMT_YUVJ420P, width, height);
+    int numBytes = av_image_get_buffer_size(AV_PIX_FMT_YUV420P, width, height, 1);
 
     uint8_t *buffer = (uint8_t *)av_malloc(numBytes);
 
@@ -271,7 +271,7 @@ QByteArray AVDecoder::WriteJPEG(AVCodecContext *pCodecCtx, AVFrame *pFrame, int
         return data;
     }
 
-    avpicture_fill((AVPicture *)pFrameRGB, buffer, PIX_FMT_YUVJ420P, width, height);
+    av_image_fill_arrays(pFrameRGB->data, pFrameRGB->linesize, buffer, AV_PIX_FMT_YUV420P, width, height, 1);
 
     sws_scale(
         sws_ctx,
@@ -306,6 +306,7 @@ QByteArray AVDecoder::WriteJPEG(AVCodecContext *pCodecCtx, AVFrame *pFrame, int
     pOCodecCtx->width         = width;
     pOCodecCtx->height        = height;
     pOCodecCtx->pix_fmt       = AV_PIX_FMT_YUVJ420P;
+    pOCodecCtx->color_range   = AVCOL_RANGE_JPEG;
     pOCodecCtx->codec_id      = AV_CODEC_ID_MJPEG;
     pOCodecCtx->codec_type    = AVMEDIA_TYPE_VIDEO;
     pOCodecCtx->time_base.num = pCodecCtx->time_base.num;
@@ -329,8 +330,11 @@ QByteArray AVDecoder::WriteJPEG(AVCodecContext *pCodecCtx, AVFrame *pFrame, int
          return  0;
     }
 
-    pOCodecCtx->mb_lmin        = pOCodecCtx->lmin = pOCodecCtx->qmin * FF_QP2LAMBDA;
-    pOCodecCtx->mb_lmax        = pOCodecCtx->lmax = pOCodecCtx->qmax * FF_QP2LAMBDA;
+    av_opt_set_int(pOCodecCtx, "lmin", pOCodecCtx->qmin * FF_QP2LAMBDA, 0);
+    av_opt_set_int(pOCodecCtx, "lmax", pOCodecCtx->qmax * FF_QP2LAMBDA, 0);
+
+    pOCodecCtx->mb_lmin        = pOCodecCtx->qmin * FF_QP2LAMBDA;
+    pOCodecCtx->mb_lmax        = pOCodecCtx->qmax * FF_QP2LAMBDA;
     pOCodecCtx->flags          = CODEC_FLAG_QSCALE;
     pOCodecCtx->global_quality = pOCodecCtx->qmin * FF_QP2LAMBDA;
 
diff --git a/common/avdecoder.h b/common/avdecoder.h
index fca0c81..4f4de6b 100644
--- a/common/avdecoder.h
+++ b/common/avdecoder.h
@@ -26,7 +26,9 @@ extern "C" {
 #include <libavcodec/avcodec.h>
 #include <libavformat/avformat.h>
 #include <libswscale/swscale.h>
+#include <libavutil/imgutils.h>
 #include <libavutil/mathematics.h>
+#include <libavutil/opt.h>
 }
 
 #include <vitamtp.h>
